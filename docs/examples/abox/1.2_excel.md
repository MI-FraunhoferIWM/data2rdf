# ABox generation from an excel file with metadata and time series

```{note}
This example is building up on the previous one about the [CSV file with metadata and time series](1.1_csv.md).
Please start from this chapter in order to fully understand the content of this example.
```

## General understanding

In this example, we want to transfor an excel file which encorporates stress/strain of the measurement and some metadata about the experiment into an RDF repesentation.

For this purpose, we are describing the **general metadata** of the experiment as well as the **metadata of the time series**.

## The input data

In this example we will consider the following inputs:

* the excel file produced by the tensile test machine
* the mapping for describing the data in RDF
* the additional triples (optional) for describing additional concepts in RDF which are not contained in the excel file

Since excel files do not have any tab separators in order to be read, we do not need any additional parser arguments at this point.

In some cases, measurement units are referenced in the macros of the individual cells of the excel file and hence have to be extracted from there. For this purpose, we can use set `parser_args={"units_from_macros": True, "unit_macro_location": -1}` when a potential unit is located in the last macro of the cell. However, this does not apply in this example and hence will be neglected here.

### The raw data

The excel file produced by the tensile test machine looks like this:

![details](../../assets/img/docu/excel_parser/excel.JPG)

![details](../../assets/img/docu/excel_parser/excel2.JPG)

Again, we are facing metadata of the experiment like e.g. `Projekt`, `Pr√ºfer`, `Werkstoff`, etc. and time series with the quantities of `Zeit`, `F`, `B`, which need to be mapped to ontological concepts.

The original file can be accessed [here](https://github.com/MI-FraunhoferIWM/data2rdf/raw/enh/annotations/tests/abox/xls_pipeline_test/input/data/AFZ1-Fz-S1Q.xlsm).



### The mapping

In contrast to the previous CSV example, we have to provide more information about the location of the data in the excel file. Previously, we simply had to provide the `key` of the concept in the data file. But since we are using `openpyxl`, we need to provide the `worksheet`, `value_location` (in case of metadata), `time_series_start` (in case of time series) and `unit_location` (in case of quantitative data) for each concept in the excel file.

A valid mapping for the example file show above may look like this:

<blockQuote>
<Details>
<summary><b>Click here to expand</b></summary>

```{json}
[
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Remark",
    "key": "Bemerkungen",
    "value_location": "UU31",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/WidthChange",
    "key": "Breiten\u00e4nderung",
    "time_series_start": "E15",
    "unit_location": "E14",
    "worksheet": "Messdaten"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/TimeStamp",
    "key": "Datum",
    "value_location": "AD6",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Elongation",
    "key": "Dehnung",
    "time_series_start": "Q15",
    "unit": "\u00f7",
    "worksheet": "Messdaten"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/OriginalGaugeLength",
    "key": "Messl\u00e4nge Standardweg",
    "unit_location": "P16",
    "value_location": "M16",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/SpecimenWidth",
    "key": "Probenbreite b",
    "unit_location": "P15",
    "value_location": "M15",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/SpecimenThickness",
    "key": "Probendicke a",
    "unit_location": "P14",
    "value_location": "M14",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/SpecimenType",
    "key": "Probenform",
    "value_location": "AE7",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/SampleIdentifier-2",
    "key": "Probenkennung 2",
    "value_location": "U7",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/ProjectNumber",
    "key": "Projekt",
    "value_location": "F6",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Tester",
    "key": "Pr\u00fcfer",
    "value_location": "U6",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/TestingRate",
    "key": "Pr\u00fcfgeschwindigkeit",
    "value_location": "J9",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/MachineData",
    "key": "Pr\u00fcfmaschine",
    "value_location": "I8",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Temperature",
    "key": "Pr\u00fcftemperatur",
    "value_location": "U8",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/StandardForce",
    "key": "Standardkraft",
    "time_series_start": "C15",
    "unit_location": "C14",
    "worksheet": "Messdaten"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Extension",
    "key": "Standardweg",
    "time_series_start": "D15",
    "unit_location": "D14",
    "worksheet": "Messdaten"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/AbsoluteCrossheadTravel",
    "key": "Traversenweg absolut",
    "time_series_start": "B15",
    "unit_location": "B14",
    "worksheet": "Messdaten"
  },
  {
    "annotation": "https://w3id.org/steel/ProcessOntology",
    "iri": "https://w3id.org/steel/ProcessOntology/Material",
    "key": "Werkstoff",
    "value_location": "H7",
    "worksheet": "Protokoll"
  },
  {
    "iri": "https://w3id.org/steel/ProcessOntology/TestTime",
    "key": "Zeit",
    "time_series_start": "A15",
    "unit_location": "A14",
    "worksheet": "Messdaten"
  }
]
```

Please note that a mapping for a metadatum looks like this:
```
  ...
  {
    "iri": "https://w3id.org/steel/ProcessOntology/OriginalGaugeLength",
    "key": "Messl\u00e4nge Standardweg",
    "unit_location": "P16",
    "value_location": "M16",
    "worksheet": "Protokoll"
  }
  ...
```

Whereas the mapping of a time series looks like this:

```
{
"iri": "https://w3id.org/steel/ProcessOntology/TestTime",
"key": "Zeit",
"time_series_start": "A15",
"unit_location": "A14",
"worksheet": "Messdaten"
}
```

Again, the `unit_location` is only needed if the concept is a quantity, of course.

In case if the unit cannot be parsed from the excel sheet, we again have the opportunity to specify the unit in the mapping:

```{json}
  {
    "iri": "https://w3id.org/steel/ProcessOntology/Elongation",
    "key": "Dehnung",
    "time_series_start": "Q15",
    "unit": "\u00f7",
    "worksheet": "Messdaten"
  }
```

Please note the that unit is a unicode charater for the \u00f7 (fraction) - symbol. The related ontological concept for the unit will be queried from the **QUDT** ontology again from this symbol. Alternatively, you may also specify the URI (e.g. `http://qudt.org/vocab/unit/FRACTION`). For other units with simpler symbols (e.g. `mm`), you will not need the unicode representation.

### The additional triples (optional)

The method graph for this example is almost the same as from the previous csv-example. The reason is that we are still describing a tensile test with the same ontological concepts, which will result into similar IRIs with the same suffix:
<blockQuote>
<Details>
<summary><b>Click here to expand</b></summary>

```{turtle}
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix fileid: <http://abox-namespace-placeholder.org/> .

#  Describe the Tester and the Facility and lab

fileid:TestingFacility rdf:type prov:Organization , prov:Location .

fileid:TestingLab rdf:type prov:Location, prov:Agent ;
                  prov:atLocation fileid:TestingFacility .

fileid:Tester rdf:type prov:Agent ;
              prov:actedOnBehalfOf fileid:TestingFacility ;
              prov:atLocation fileid:TestingLab .

fileid:Temperature rdf:type prov:Entity ;
                   prov:wasAttributedTo fileid:TestingLab .


# describe the project

fileid:Project rdf:type prov:Activity ;
               prov:wasAssociatedWith fileid:TestingFacility ;
               prov:generated fileid:ProjectName ,
                              fileid:ProjectNumber .

fileid:ProjectName rdf:type prov:Entity .

fileid:ProjectNumber rdf:type prov:Entity .


# Describe the Specimen and its attributes

fileid:SamplePreparatation rdf:type prov:Activity ;
                           prov:wasAssociatedWith fileid:TensileTestSpecimen ,
                                                  fileid:Material ;
                           prov:generated fileid:ParallelLength ,
                                          fileid:SpecimenThickness ,
                                          fileid:SpecimenType ,
                                          fileid:SpecimenWidth ;
                           prov:wasInfluencedBy fileid:Project .

fileid:TensileTestSpecimen rdf:type prov:Agent , prov:Entity .

fileid:Material rdf:type prov:Agent .

fileid:ParallelLength rdf:type prov:Entity ;
                      prov:wasAttributedTo fileid:TensileTestSpecimen .

fileid:SpecimenThickness rdf:type prov:Entity ;
                         prov:wasAttributedTo fileid:TensileTestSpecimen .

fileid:SpecimenType rdf:type prov:Entity ;
                    prov:wasAttributedTo fileid:TensileTestSpecimen .

fileid:SpecimenWidth rdf:type prov:Entity ;
                    prov:wasAttributedTo fileid:TensileTestSpecimen .

# Describe the experiment preparation

fileid:ExperimentPreparation rdf:type prov:Activity ;
                             prov:atLocation fileid:TestingLab ;
                             prov:wasAssociatedWith fileid:Tester ,
                                                    fileid:ForceMeasuringDevice ,
                                                    fileid:DisplacementTransducer ,
                                                    fileid:TensileTestSpecimen ,
                                                    fileid:TensileTestingMachine ;
                             prov:generated fileid:Preload ,
                                            fileid:OriginalGaugeLength ,
                                            fileid:TestingRate ;
                            prov:wasInfluencedBy fileid:SamplePreparatation .

fileid:TensileTestingMachine rdf:type prov:Agent, prov:Entity ;
                             prov:atLocation fileid:TestingLab .

fileid:ForceMeasuringDevice rdf:type prov:Agent, prov:Entity ;
                            prov:atLocation fileid:TestingLab .

fileid:DisplacementTransducer rdf:type prov:Agent , prov:Entity ;
                              prov:atLocation fileid:TestingLab .

fileid:TestingRate rdf:type prov:Entity ;
                   prov:wasAttributedTo fileid:TensileTestingMachine .

fileid:Preload rdf:type prov:Entity ;
               prov:wasAttributedTo fileid:TensileTestingMachine .

fileid:OriginalGaugeLength rdf:type prov:Entity ;
                           prov:wasAttributedTo fileid:DisplacementTransducer .


# Describe the experiment and its data produced by which device

fileid:dataset rdf:type prov:Entity .

fileid:TensileTestExperiment rdf:type prov:Activity ;
    prov:wasAssociatedWith fileid:Tester ;
    prov:used fileid:TensileTestSpecimen ,
              fileid:TensileTestingMachine ,
              fileid:ForceMeasuringDevice ,
              fileid:DisplacementTransducer ,
              fileid:TestingFacility ;
    prov:generated fileid:Extension ,
                   fileid:StandardForce ,
                   fileid:AbsoluteCrossheadTravel ,
                   fileid:Remark ,
                   fileid:TimeStamp ,
                   fileid:dataset ;
    prov:hadPlan fileid:TestStandard ;
    prov:wasInfluencedBy fileid:ExperimentPreparation .

fileid:AbsoluteCrossheadTravel rdf:type prov:Entity;
                               prov:wasDerivedFrom fileid:DisplacementTransducer .

fileid:StandardForce rdf:type prov:Entity ;
                     prov:wasDerivedFrom fileid:ForceMeasuringDevice .

fileid:Extension rdf:type prov:Entity ;
                 prov:wasDerivedFrom fileid:DisplacementTransducer .

fileid:TestingStandard rdf:type prov:Plan .

```

</Details>
</blockQuote>

## Next steps

Please go to the next section for investigating more pipeline usecases or go to the [Run pipeline and retrieve outputs](3_pipeline_run_and_outputs) section for more details how to run the pipeline with the given setup.
